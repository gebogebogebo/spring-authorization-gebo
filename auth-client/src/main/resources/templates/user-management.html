<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Management - Spring Authorization Client Demo</title>
    <meta name="_csrf" th:content="${_csrf?.token}" />
    <meta name="_csrf_header" th:content="${_csrf?.headerName}" />
    <style>
      body { font-family: sans-serif; margin: 0; min-height: 100vh; display: flex; justify-content: center; align-items: flex-start; padding: 2rem 1rem; box-sizing: border-box; }
      .main { width: 100%; max-width: 42rem; }
      .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
      .header h1 { margin: 0; font-size: 1.5rem; }
      section { margin-bottom: 1.5rem; }
      section h2 { margin: 0 0 0.5rem 0; font-size: 1.1rem; }
      .alert { margin: 0.5rem 0; }
      .create-form { display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; }
      .create-form label { display: inline-flex; align-items: center; gap: 0.25rem; }
      #create-result { margin-top: 0.5rem; display: none; }
      table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
      th, td { border: 1px solid #333; padding: 0.5rem; text-align: left; }
      th { background: #f5f5f5; }
    </style>
  </head>
  <body>
    <main class="main">
    <header class="header">
      <h1>User Management</h1>
      <p style="margin: 0;"><a href="/home">/home に戻る</a></p>
    </header>

    <p th:if="${errorMessage}" class="alert" role="alert" th:text="${errorMessage}">Error</p>

    <section>
      <h2>Add account</h2>
      <form id="create-account-form" class="create-form">
        <label>Username <input type="text" name="username" required minlength="1" /></label>
        <label>Password <input type="password" name="password" required minlength="1" /></label>
        <label><input type="checkbox" name="enabled" checked /> Enabled</label>
        <label>Roles
          <select name="roles">
            <option value="USER" selected>USER</option>
            <option value="ADMIN">ADMIN</option>
          </select>
        </label>
        <button type="submit">Add</button>
      </form>
      <p id="create-result" role="alert"></p>
    </section>

    <section>
      <h2>Accounts</h2>
      <p th:if="${accounts != null and #lists.isEmpty(accounts)}">No accounts found.</p>
      <table th:if="${accounts != null and !#lists.isEmpty(accounts)}">
        <thead>
          <tr>
            <th>Username</th>
            <th>Enabled</th>
            <th>Roles</th>
          </tr>
        </thead>
        <tbody>
          <tr th:each="account : ${accounts}">
            <td th:text="${account.username}">username</td>
            <td th:text="${account.enabled}">true</td>
            <td th:text="${#strings.listJoin(account.roles, ', ')}">ROLE_USER</td>
          </tr>
        </tbody>
      </table>
    </section>

    <script th:inline="javascript">
      (function () {
        const form = document.getElementById('create-account-form');
        const resultEl = document.getElementById('create-result');
        const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

        form.addEventListener('submit', function (e) {
          e.preventDefault();
          const username = form.username.value.trim();
          const password = form.password.value;
          const enabled = form.enabled.checked;
          const roles = [form.roles.value];

          resultEl.style.display = 'none';
          resultEl.textContent = '';

          const headers = {
            'Content-Type': 'application/json'
          };
          if (csrfToken && csrfHeader) {
            headers[csrfHeader] = csrfToken;
          }

          fetch('/user-management/accounts', {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({ username: username, password: password, enabled: enabled, roles: roles })
          })
            .then(function (res) {
              if (res.ok) {
                resultEl.style.color = 'green';
                resultEl.textContent = 'Account created.';
                resultEl.style.display = 'block';
                form.username.value = '';
                form.password.value = '';
                form.roles.selectedIndex = 0;
                window.location.reload();
                return;
              }
              return res.json().then(function (body) {
                resultEl.style.color = 'red';
                resultEl.style.display = 'block';
                if (res.status === 409) {
                  resultEl.textContent = 'Username already exists.';
                } else {
                  resultEl.textContent = body.error || 'Failed to create account.';
                }
              });
            })
            .catch(function () {
              resultEl.style.color = 'red';
              resultEl.style.display = 'block';
              resultEl.textContent = 'Network error.';
            });
        });
      })();
    </script>
    </main>
  </body>
</html>
